<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-apis/google-client-api.html">
<link rel="import" href="promise-import.html">

<!--
Element providing a Result Set executed against Google BigQuery

##### Example

    <bigquery-api
        title="Wikipedia Top Topics"
        query="SELECT TOP(title, 10) as title, COUNT(*) as revision_count FROM [publicdata:samples.wikipedia] WHERE wp_namespace = 0;"
        projectId="YOUR_PROJECT_ID"
    </bigquery-api>

@element bigquery-api
@blurb Element providing a Result Set executed against Google BigQuery
@status alpha
@url http://blackhawkwebcomponents.github.io/bigquery-api
-->
<polymer-element name="bigquery-api" attributes="projectId query response auto">
    <template>

        <google-api-loader
                name="bigquery"
                version="v2">
        </google-api-loader>

    </template>
    <script>
        (function() {

            /**
             * A promise that is resolved when the underlying client libraries are
             * loaded. It is rejected if there are any load errors.
             */
            var loadPromise = new Promise(function(resolve, reject) {
                document.addEventListener('google-api-load', function fn(event) {
                    var lib = event.detail;
                    if (lib.name == 'bigquery' && lib.version == 'v2') {
                        resolve(event.detail);
                        document.removeEventListener('google-api-load', fn);
                    }
                });
                document.addEventListener('google-api-load-error', function fn(event) {
                    var lib = event.detail;
                    if (lib.name == 'bigquery' && lib.version == 'v2') {
                        reject(event.detail.error);
                        document.removeEventListener('google-api-load-error', fn);
                    }
                });
            });

            // Log any errors loading the client library.
            loadPromise.catch(function(err) {
                console.error(err.stack || err);
            })

            Polymer('bigquery-api', {
                /**
                 * Setting auto will run the query any time it changes
                 * @attribute auto
                 * @type boolean
                 * @default false
                 */
                auto: false,
                /**
                 * A query to execute against Big Query api.
                 * @attribute query
                 * @type string
                 * @default null
                 */
                query: null,
                /**
                 * Application's projectId for using Big Query API.
                 * @attribute projectId
                 * @type string
                 */
                projectId: null,

                publish: {
                    /**
                     * The `authorized` attribute is true when the user has signed-in and
                     * the underlying bigquery library is fully loaded.
                     *
                     * @attribute authorized
                     * @type boolean
                     */
                    authorized: {
                        value: false,
                        reflect: true
                    }
                },

                created: function() {
                    this.response = {};
                    document.addEventListener('google-signin-success', function(event) {
                        loadPromise
                                .then(this.userAuthorized.bind(this,event.detail.result));
                    }.bind(this));
                    document.addEventListener('google-signed-out', function(event) {
                        this.userUnauthorized();
                    }.bind(this));
                },

                /**
                 * The `userAuthorized` method will be invoked when the user has
                 * successfully signed in and all the underlying client libraries
                 * have been loaded.
                 *
                 * @method userAuthorized
                 * @param {Object} data - The auth data information.
                 */
                userAuthorized: function(data) {
                    this.authorized = true;
                },

                /**
                 * The `userUnauthorized` method will be invoked when the user has
                 * successfully signed out.
                 *
                 * @method userUnauthorized
                 */
                userUnauthorized: function() {
                    this.authorized = false;
                },

                observe: {
                    'query authorized': 'stateChanged'
                },

                stateChanged: function() {
                    //console.log('stateChanged', this.auto, this.authorized, this.query);
                    if (this.auto && this.authorized && this.query != null) {
                        //console.log('running query');
                        this.runQuery();
                    }
                },
                /**
                 * Runs a BigQuery query job
                 *
                 * @method runQuery
                 */
                runQuery: function () {
                    var request = gapi.client.bigquery.jobs.query({
                        'projectId': this.projectId,
                        'timeoutMs': '30000',
                        'query': this.query
                    });
                    request.execute(function (response) {
                        //console.log(JSON.stringify(response.result));
                        this.response = response.result;
                        this.processResponse(response.result);
                    }.bind(this));
                },

                processResponse: function(response) {
                    //console.log('in processResponse', response);
                    this.fire('bigquery-response', {response: response});
                }
            });
        }());
    </script>
</polymer-element>

